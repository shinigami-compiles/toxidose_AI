<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results - ToxiDose AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/png" sizes="32x32"
      href="{{ url_for('static', filename='img/toxiDose_logo.ico') }}">
    <link rel="icon" type="image/png" sizes="16x16"
      href="{{ url_for('static', filename='img/toxidose-favicon-16.png') }}">

</head>
<body>
    <div id="background-animation"></div>
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-dialog">
            <div class="loading-gif">
                <img src="{{ url_for('static', filename='loading.gif') }}" alt="Loading...">
            </div>
            <div class="loading-message">Analyzing toxicity risk‚Ä¶</div>
        </div>
    </div>
    <nav>
        <div class="logo">
            <img 
                src="{{ url_for('static', filename='toxiDose_logo.png') }}" 
                alt="ToxiDose Logo" 
                class="nav-logo-img"
            >
            <span class="logo-text">ToxiDose AI</span>
        </div>
        <ul>
            <li>
                <a href="{{ url_for('landing') }}"
                   class="nav-link nav-link-tablet {% if request.endpoint == 'landing' %}active{% endif %}"
                   data-tablet-img="{{ url_for('static', filename='img/tablet-nav.png') }}">
                    Home
                </a>
            </li>
            <li>
                <a href="{{ url_for('how_it_works') }}"
                   class="nav-link nav-link-tablet {% if request.endpoint == 'how_it_works' %}active{% endif %}"
                   data-tablet-img="{{ url_for('static', filename='img/tablet-nav.png') }}">
                    Functions
                </a>
            </li>
            <li>
                <a href="{{ url_for('help_page') }}"
                   class="nav-link nav-link-tablet {% if request.endpoint == 'help_page' %}active{% endif %}"
                   data-tablet-img="{{ url_for('static', filename='img/tablet-nav.png') }}">
                    Help
                </a>
            </li>
        </ul>

    </nav>

    <div class="content-wrapper">
        {% if mode == 'single' %}
        <div class="results-container">
            <!-- Header -->
            <div class="results-header">
                <h1 class="results-title">Analysis Report</h1>
                <p class="results-subtitle">Generated by ToxiDose AI</p>
            </div>

            <!-- Risk Cards -->
            <div class="risk-cards-wrapper">
                <!-- Immediate Risk card with soft ECG / emergency style background -->
                <div class="risk-card section-soft-bg
                            {{ 'risk-high' if data.acute_risk_score > 60 else ('risk-caution' if data.acute_risk_score > 30 else 'risk-low') }}"
                     style="--section-bg: url('{{ url_for('static', filename='img/danger.png') }}');">
                    <div class="risk-card-icon">‚ö°</div>
                    <h3 class="risk-card-title">Immediate Risk</h3>
                    <div class="risk-score">{{ data.acute_risk_score }}</div>
                    <div class="risk-score-max">/ 100</div>
                    <div class="risk-bucket">{{ data.acute_bucket }}</div>
                    <p class="risk-description">
                        Immediate organ stress probability based on current active dosage levels.
                    </p>
                </div>

                <!-- Long-Term Risk card with subtle organ scan background -->
                <div class="risk-card section-soft-bg
                            {{ 'risk-high' if data.cumulative_risk_score > 60 else ('risk-caution' if data.cumulative_risk_score > 30 else 'risk-low') }}"
                     style="--section-bg: url('{{ url_for('static', filename='img/Co-risk.png') }}');">
                    <div class="risk-card-icon">‚è≥</div>
                    <h3 class="risk-card-title">Long-Term Risk</h3>
                    <div class="risk-score">{{ data.cumulative_risk_score }}</div>
                    <div class="risk-score-max">/ 100</div>
                    <div class="risk-bucket">{{ data.cumulative_bucket }}</div>
                    <p class="risk-description">
                        Long-term toxicity potential if this medication regimen continues.
                    </p>
                </div>
            </div>


            <!-- Patient & Regimen Summary -->
            <div class="summary-section">
                <div class="summary-card section-soft-bg"
                     style="--section-bg: url('{{ url_for('static', filename='img/patient.png') }}');">
                    <div class="summary-header">
                        <span class="summary-icon">üë§</span>
                        <h3>Patient Profile</h3>
                    </div>
                    <div class="summary-content">
                        <div class="info-row">
                            <span class="info-label">Age:</span>
                            <span class="info-value">{{ patient.patient_age }} years ({{ patient.age_group }})</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Weight:</span>
                            <span class="info-value">{{ patient.weight_kg }} kg</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Sex:</span>
                            <span class="info-value">{{ patient.sex|capitalize }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Medical Conditions:</span>
                            <span class="info-value">
                                {% set conditions = [] %}
                                {% if patient.is_pregnant %} {% set _ = conditions.append('Pregnant') %} {% endif %}
                                {% if patient.has_liver_disease %} {% set _ = conditions.append('Liver Disease') %} {% endif %}
                                {% if patient.has_kidney_disease %} {% set _ = conditions.append('Kidney Disease') %} {% endif %}
                                {% if patient.has_heart_disease %} {% set _ = conditions.append('Heart Disease') %} {% endif %}
                                {% if patient.has_diabetes %} {% set _ = conditions.append('Diabetes') %} {% endif %}
                                {% if patient.has_gi_ulcer_or_gastritis %} {% set _ = conditions.append('GI Issues') %} {% endif %}
                                {% if patient.has_asthma_or_copd %} {% set _ = conditions.append('Asthma/COPD') %} {% endif %}
                                
                                {% if conditions %}
                                    <span class="conditions-list">{{ conditions|join(', ') }}</span>
                                {% else %}
                                    <span class="no-conditions">None Reported ‚úì</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>

                <div class="summary-card">
                    <div class="summary-card section-soft-bg"
                         style="--section-bg: url('{{ url_for('static', filename='img/medicine.png') }}');">
                        <div class="summary-header">
                            <span class="summary-icon">üíä</span>
                            <h3>Medication Regimen</h3>
                        </div>
                    <div class="summary-content">
                        {% for med in regimen %}
                        <div class="medicine-summary">
                            <div class="medicine-name">{{ med.drug_name }}</div>
                            <div class="medicine-details">
                                <span class="detail-badge">{{ med.dose_mg_per_unit }}mg √ó {{ med.units_per_dose }}</span>
                                <span class="detail-badge">{{ med.doses_per_day }}√ó daily</span>
                            </div>
                            <div class="medicine-meta">
                                Taken for {{ med.days_taken_so_far }} days ‚Ä¢ Last dose: {{ med.hours_since_last_dose }}h ago
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- SHAP Explanation -->
            {% if shap_plot %}
            <div class="explanation-section no-soft-bg">
                <div class="explanation-header">
                    <span class="explanation-icon">ü§ñ</span>
                    <h3>AI Explanation: Why This Score?</h3>
                </div>
                <p class="explanation-subtitle">
                    This waterfall chart shows which factors increased 
                    <span class="highlight-red">risk (red)</span> or decreased 
                    <span class="highlight-blue">risk (blue)</span>.
                </p>
                <div class="chart-container">
                    <img src="data:image/png;base64,{{ shap_plot }}" alt="AI Explanation Chart" class="shap-chart">
                </div>
            </div>
            {% endif %}

            <!-- Technical Details -->
            <details class="technical-details no-soft-bg">
                <summary class="technical-summary">
                    <span class="summary-icon">üî¨</span>
                    <span>Show Technical Feature Analysis</span>
                </summary>
                <div class="technical-grid">
                    {% for key, value in data.features.items() %}
                        {% if 'effective' in key or 'load' in key or 'ratio' in key %}
                        <div class="tech-item">
                            <span class="tech-key">{{ key.replace('_', ' ')|title }}:</span>
                            <span class="tech-value">{{ "%.2f"|format(value) }}</span>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </details>

            <!-- Actions -->
            <div class="results-actions">
                <a href="/" class="action-btn secondary">
                    <span class="btn-icon">‚Üê</span>
                    <span>New Assessment</span>
                </a>
               <!-- Inside the footer area of the result page -->
                <a href="{{ url_for('download_report') }}"
                   class="action-btn primary report-download-btn">
                    Download PDF Report
                </a>



            </div>
        </div>

        {% else %}
        <!-- Batch Results -->
        <div class="batch-results-container">
            <div class="results-header">
                <h1 class="results-title">Batch Processing Results</h1>
                <p class="results-subtitle">Showing first 50 entries from uploaded file</p>
            </div>

            <div class="table-wrapper">
                <table class="results-table">
                    <thead>
                        <tr>
                            {% if data|length > 0 %}
                                {% for key in data[0].keys() %}
                                <th>{{ key|replace('_', ' ')|title }}</th>
                                {% endfor %}
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data %}
                        <tr>
                            {% for key, value in row.items() %}
                            <td {% if 'Risk' in key %}class="risk-cell"{% endif %}>
                                {{ value }}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="results-actions">
                <a href="/" class="action-btn secondary">
                    <span class="btn-icon">‚Üê</span>
                    <span>Back to Home</span>
                </a>
            </div>
        </div>
        {% endif %}
    </div>

    <footer>
        <div class="footer-content">
            <p class="footer-warning">‚ö†Ô∏è Research Prototype - Not for Clinical Diagnosis</p>
            <p class="footer-copy">&copy; 2025 ToxiDose AI Project</p>
        </div>
    </footer>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>